# pseudobulk_fragment_metagene 

## Description
`pseudobulk_fragment_metagene` is used for creating scATAC-seq metagene
plots stratified by cell groups (such as cell clusters). It takes as
input a list of regions (such as gene body regions or regions
surrounding transcription start sites). It divides each region into
identical number of bins, and computes the number of bases that are
aligned in each bin. All the cells belonging to a specific group are
treated as one, in effect pseudo-bulking the cells.  

## Parameters
```
pseudobulk_fragment_metagene [options]
  -a aligned SAM/BAM file [required]
  -b barcode list file [required]
  -r regions bed file [required]
  -o out file prefix [required]
  -n number of divisions for a region [default: 100]
  -m min. fragment length [default: 0]
  -M max. fragment length [default: 1024]
  -d name split delimeter [default: ":"]; ignored if -t is provided
  -c barcode field in name [default: 7 (0 based); ignored if -t is provided]
  -t barcode tag in SAM file [default ""]
  -q minimum mapping quality to include [default: 0]
  -f only include if all the flags are present [default: 3]
  -F only include if none of the flags are present [default: 3340]
  -v verbose [default: false]
```

`-a`: The input aligned paired end SAM or BAM file. The cell barcode
should be present either in a SAM tag or encoded in the query name
(QNAME) field, see options `\t`, `-d`, and `-c`. [Required].

`-b`: A two column file with cell barcodes in the first column and the
group the cell belongs to in the second column.  Only the SAM/BAM
entries that match a barcode in this file are processed. [Required].

`-r` A bed-6 file with the regions of interest. Specifically the first 3
standard columns, the 4th column with the region name, and the 6th column
with the stand orientation info are used. See below on how to generate
this file [Required]. 

`-o`: Output file prefix. [Default = ""].

`-n`: Number of divisions to split each region into. [Default: 100].

`-m`: Minimum fragment length to include. Alignments that have a
fragment length (insert size) lower than this value are ignored.
[Default: 0].

`-M`: Maximum fragment length to include. Alignments that have a
fragment length (insert size) higher than this value are ignored.
[Default: 1024].

`-d`: Used when the cell barcode is encoded as a part of the query name
(QNAME field). Split the QNAME by the specified delimiter. [Default:
":"]. 

`-c`: Used when the cell barcode is encoded as a part of the query name
(QNAME field). Split the QNAME by the delimiter specified by `-d`
and take the barcode as the value in the columns specified by `-c` (0
based). For example, reads that are generated by Illumina sequencers
have a FASTQ names that have 7 fields that are separated by a ":", and
the cell barcode is typically added as the 8th field. [Default: 7].   

`-t`: Used when the cell barcode is present in a SAM entry as a tag. For
example, SAM files generated by CellRanger encodes the error correct
cell barcode in the `CB` tag. If this parameter is set, `-d` and `-c`
flags are ignored. [Default: none]

`-q`: Include only fragments for which both reads have a mapping
quality greater than or equal to the specified value. [Default: 0]

`-f`: Include only fragments for which both reads have all of the
specified flags present. For example, to include paired reads (0x1 or
0b1) and reads that are mapped in proper pair (0x2 or 0b2), specify the
sum of of these flags (1 + 2 = 3). [Default: 3]. 

`-F`: Include only fragments for which both reads have none of the
specified frags present. For example, to exclude PCR duplicates (0x400
or 0b1024) and supplementary alignments (0x800 or 0b2048), specify the
sum of these flags (1024 + 2048 = 3072). [default: 3340].

`-v`: Verbosity flag. Set the flag to print progress and statistics to
standard error. [Default: false].

## Input and output file description

### Description of input files
1. An aligned SAM/BAM file that has a cell barcode encoded
either in the query name or in a tag.  
1. A two column TSV file with cell barcodes in the first column and the
group the cell belongs to in the second column. Only the alignments
containing barcodes in the file are retained in the output SAM file.  
1. A bed-6 file with the regions of interest. This file is expected to
contain all the 6 bed columns. Additionally, all the regions that have a
same name (in the 4th columns) are expected to be contiguous, and they
should be sorted by genome positions within each regions. This can be
accomplished by sorting a bed file with:

```
cat in_unsorted.bed | sort -k1,1 -k4,4 -k2,2n > out_sorted.bed
```

### Description of output files
1. `<output_prefix>_metagene.txt`: A file with one row pre group and per
region (in the input bed file). The first two columns are the group ID
and region ID, these are followed by number columns specified in the `n`
parameter (default: 100). They contain the number of bases aligned to
a specific bin within a region. This file contains a header line.  
1. `<output_prefix>_metagene_normalization.txt`: A number of per group
stats that could be useful for downstream normalization. This file
contains a header line.  

